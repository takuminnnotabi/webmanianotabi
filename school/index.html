<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚é–“å‰²è¡¨ç¤ºæ¿</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #00b140;
            --primary-orange: #f5a623;
            --primary-yellow: #c8e038;
            --dark-bg: #3d3d3d;
            --darker-bg: #2d2d2d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'M PLUS Rounded 1c', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        
        /* Editor Container */
        .editor-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .page-title {
            color: #fff;
            font-size: 24px;
            font-weight: 800;
        }
        
        .page-title span {
            background: linear-gradient(90deg, var(--primary-orange), var(--primary-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .fullscreen-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--primary-green), #008830);
            color: #fff;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            box-shadow: 0 4px 15px rgba(0,177,64,0.4);
            transition: all 0.3s;
        }
        
        .fullscreen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,177,64,0.5);
        }
        
        /* Editor Panel */
        .editor-panel {
            background: rgba(255,255,255,0.98);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .editor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(0,177,64,0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        /* Day Tabs */
        .day-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .day-tab {
            padding: 10px 20px;
            background: #e8e8e8;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .day-tab.active {
            background: var(--primary-orange);
            color: #000;
        }
        
        .day-tab:hover:not(.active) {
            background: #d8d8d8;
        }
        
        /* Period List */
        .period-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .period-item {
            display: grid;
            grid-template-columns: 100px 80px 80px 1fr 1fr 40px;
            gap: 10px;
            align-items: center;
            padding: 12px;
            background: #f8f8f8;
            border-radius: 8px;
        }
        
        .period-item input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }
        
        .period-item input:focus {
            outline: none;
            border-color: var(--primary-green);
        }
        
        .period-item .label-input {
            font-weight: 700;
            text-align: center;
            background: var(--primary-orange);
            color: #000;
        }
        
        .period-item .time-input {
            text-align: center;
        }
        
        .delete-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: #e74c3c;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .delete-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }
        
        .add-period-btn {
            padding: 12px 24px;
            background: var(--primary-green);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .add-period-btn:hover {
            background: #009935;
        }
        
        /* Button Row */
        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .btn-save { background: var(--primary-green); color: #fff; }
        .btn-load { background: var(--primary-orange); color: #000; }
        .btn-reset { background: #e74c3c; color: #fff; }
        
        .btn:hover { transform: translateY(-2px); }
        
        /* Preview */
        .preview-label {
            color: #fff;
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.7;
        }
        
        /* ===== DISPLAY BOARD ===== */
        .board {
            width: 100%;
            max-width: 1100px;
            margin: 0 auto;
            background: var(--dark-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
        }
        
        /* Fullscreen styles */
        .board:fullscreen {
            border-radius: 0;
            max-width: none;
            display: flex;
            flex-direction: column;
        }
        
        .board:-webkit-full-screen {
            border-radius: 0;
            max-width: none;
        }
        
        /* Header */
        .board-header {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            background: var(--dark-bg);
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .train-type-badge {
            background: linear-gradient(180deg, #d4e830 0%, #a8c020 100%);
            color: #000;
            font-size: 38px;
            font-weight: 900;
            padding: 10px 25px;
            letter-spacing: 0.2em;
            border-radius: 6px;
        }
        
        .next-label {
            color: #fff;
            font-size: 28px;
            font-weight: 700;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: auto;
        }
        
        .time-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .time-label {
            color: #fff;
            font-size: 22px;
            font-weight: 500;
        }
        
        .time-value {
            background: #fff;
            color: #000;
            font-size: 32px;
            font-weight: 700;
            padding: 8px 20px;
            border-radius: 6px;
            font-family: 'Consolas', 'M PLUS Rounded 1c', monospace;
            min-width: 110px;
            text-align: center;
        }
        
        .class-badge {
            display: flex;
            align-items: baseline;
            gap: 4px;
        }
        
        .class-number-box {
            background: #fff;
            border: 4px solid var(--primary-green);
            border-radius: 6px;
            padding: 5px 15px;
        }
        
        .class-number-value {
            color: var(--primary-green);
            font-size: 42px;
            font-weight: 900;
            line-height: 1;
        }
        
        .class-unit {
            color: #fff;
            font-size: 22px;
            font-weight: 700;
        }
        
        /* Main Display */
        .main-display {
            display: flex;
            background: var(--darker-bg);
            border-top: 3px solid #555;
        }
        
        .day-section {
            background: linear-gradient(180deg, #f5a623 0%, #e08a10 100%);
            padding: 20px 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-width: 140px;
        }
        
        .day-display {
            color: #000;
            font-size: 52px;
            font-weight: 900;
            letter-spacing: 0.15em;
        }
        
        .schedule-type-display {
            color: #6b0000;
            font-size: 20px;
            font-weight: 800;
            margin-top: 5px;
        }
        
        .current-period-section {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 25px 35px;
            gap: 25px;
        }
        
        .period-indicator {
            width: 85px;
            height: 85px;
            border: 6px solid var(--primary-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            flex-shrink: 0;
        }
        
        .period-indicator-text {
            color: #000;
            font-size: 45px;
            font-weight: 900;
        }
        
        .current-subject {
            color: #fff;
            font-size: 80px;
            font-weight: 900;
            letter-spacing: 0.03em;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        
        /* Schedule Grid */
        .schedule-grid-section {
            background: #fff;
            padding: 18px 25px 8px;
            overflow-x: auto;
        }
        
        .schedule-grid {
            display: flex;
            gap: 8px;
            text-align: center;
            min-width: fit-content;
        }
        
        .schedule-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100px;
            min-width: 70px;
            flex: 1;
            padding: 5px;
        }
        
        .schedule-item.hr-slot {
            min-width: 55px;
            flex: 0;
        }
        
        .schedule-item .subject-char {
            font-size: 28px;
            font-weight: 800;
            color: #000;
            line-height: 1.15;
        }
        
        .schedule-item.hr-slot .subject-char {
            font-size: 24px;
        }
        
        /* Timeline */
        .timeline-section {
            background: #fff;
            padding: 5px 25px 12px;
            overflow-x: auto;
        }
        
        .timeline {
            display: flex;
            gap: 8px;
            position: relative;
            min-width: fit-content;
        }
        
        .timeline-track {
            position: absolute;
            top: 50%;
            left: 28px;
            right: 28px;
            height: 14px;
            background: var(--primary-orange);
            transform: translateY(-50%);
            border-radius: 7px;
            z-index: 0;
        }
        
        .progress-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-green) 0%, #00d050 100%);
            border-radius: 7px;
            transition: width 1s ease;
            box-shadow: 0 0 10px rgba(0,177,64,0.5);
        }
        
        .timeline-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 45px;
            min-width: 70px;
            flex: 1;
            position: relative;
            z-index: 1;
        }
        
        .timeline-marker.hr-slot {
            min-width: 55px;
            flex: 0;
        }
        
        .timeline-dot {
            width: 28px;
            height: 28px;
            background: #fff;
            border: 5px solid var(--primary-green);
            border-radius: 50%;
            transition: all 0.5s ease;
        }
        
        .timeline-dot.filled {
            background: var(--primary-green);
        }
        
        .period-circle {
            min-width: 38px;
            height: 38px;
            padding: 0 8px;
            background: #fff;
            border: 3px solid #333;
            border-radius: 19px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 800;
            color: #000;
            transition: all 0.5s ease;
        }
        
        .period-circle.active {
            background: var(--primary-green);
            color: #fff;
            border-color: var(--primary-green);
            transform: scale(1.15);
            box-shadow: 0 0 15px rgba(0,177,64,0.5);
        }
        
        .period-circle.passed {
            background: var(--primary-green);
            color: #fff;
            border-color: var(--primary-green);
        }
        
        .hour-label {
            font-size: 16px;
            color: var(--primary-orange);
            font-weight: 800;
        }
        
        /* Room Info */
        .room-info-section {
            background: #fff;
            padding: 5px 25px 18px;
            overflow-x: auto;
        }
        
        .room-grid {
            display: flex;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
            color: #555;
            min-width: fit-content;
        }
        
        .room-grid span {
            text-align: center;
            min-width: 70px;
            flex: 1;
        }
        
        .room-grid span.hr-slot {
            min-width: 55px;
            flex: 0;
        }
        
        /* Footer */
        .board-footer {
            background: #f0f0f0;
            padding: 14px 25px;
            text-align: center;
            border-top: 2px solid #ddd;
        }
        
        .footer-message {
            color: #c00;
            font-size: 15px;
            font-weight: 600;
        }
        
        /* End of day display */
        .end-of-day-display {
            display: none;
        }
        
        .end-of-day-display.show {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            flex: 1;
        }
        
        .end-title {
            font-size: 90px;
            font-weight: 900;
            color: #fff;
            margin-bottom: 20px;
        }
        
        .end-message {
            font-size: 32px;
            font-weight: 700;
            color: #aaa;
            text-align: center;
            line-height: 1.5;
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            .train-type-badge { font-size: 28px; padding: 8px 18px; }
            .current-subject { font-size: 55px; }
            .day-display { font-size: 38px; }
            .period-item { grid-template-columns: 80px 70px 70px 1fr 1fr 36px; gap: 6px; }
        }
        
        @media (max-width: 600px) {
            .editor-grid { grid-template-columns: 1fr; }
            .period-item { 
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            .period-item .delete-btn {
                grid-column: 2;
                justify-self: end;
            }
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="page-header">
            <h1 class="page-title">ğŸšƒ <span>æ™‚é–“å‰²è¡¨ç¤ºæ¿</span> ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</h1>
            <button class="fullscreen-btn" onclick="enterFullscreen()">ğŸ–¥ï¸ å…¨ç”»é¢è¡¨ç¤º</button>
        </div>
        
        <!-- Editor Panel -->
        <div class="editor-panel">
            <div class="section-title">ğŸ“‹ åŸºæœ¬è¨­å®š</div>
            <div class="editor-grid">
                <div class="form-group">
                    <label>è¡¨ç¤ºåï¼ˆå·¦ä¸Šã®ãƒ©ãƒ™ãƒ«ï¼‰</label>
                    <input type="text" id="displayName" value="æ™® é€š" oninput="updateBoard()">
                </div>
                <div class="form-group">
                    <label>ã‚¯ãƒ©ã‚¹ç•ªå·</label>
                    <input type="text" id="classNum" value="3" oninput="updateBoard()">
                </div>
                <div class="form-group">
                    <label>ã‚¯ãƒ©ã‚¹å˜ä½ï¼ˆçµ„ãªã©ï¼‰</label>
                    <input type="text" id="classUnit" value="çµ„" oninput="updateBoard()">
                </div>
                <div class="form-group">
                    <label>æ—¥èª²ã‚¿ã‚¤ãƒ—</label>
                    <input type="text" id="scheduleType" value="æ—¥èª²" oninput="updateBoard()">
                </div>
            </div>
            
            <div class="section-title">ğŸŒ™ çµ‚äº†å¾Œã®è¡¨ç¤º</div>
            <div class="editor-grid">
                <div class="form-group">
                    <label>çµ‚äº†å¾Œã®ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="endTitle" value="æœ¬æ—¥çµ‚äº†" oninput="updateBoard()">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>çµ‚äº†å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                    <textarea id="endMessage" oninput="updateBoard()">æœ¬æ—¥ã®æˆæ¥­ã¯å…¨ã¦çµ‚äº†ã—ã¾ã—ãŸã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚</textarea>
                </div>
            </div>
            
            <div class="section-title">âš™ï¸ ãƒ•ãƒƒã‚¿ãƒ¼è¨­å®š</div>
            <div class="form-group">
                <label>ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                <input type="text" id="footerMsg" value="ç§»å‹•ã€æº–å‚™æ™‚é–“ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚æˆæ¥­ã«ã‚ˆã‚Šå¤šå°‘æ™‚é–“ãŒç•°ãªã‚Šã¾ã™ã€‚" oninput="updateBoard()" style="width:100%">
            </div>
        </div>
        
        <!-- Schedule Editor -->
        <div class="editor-panel">
            <div class="section-title">ğŸ“… æ™‚é–“å‰²ç·¨é›†</div>
            <div class="day-tabs" id="dayTabs"></div>
            
            <div class="period-list" id="periodList"></div>
            
            <button class="add-period-btn" onclick="addPeriod()">ï¼‹ æ™‚é™ã‚’è¿½åŠ </button>
            
            <div class="button-row">
                <button class="btn btn-save" onclick="saveData()">ğŸ’¾ ä¿å­˜</button>
                <button class="btn btn-load" onclick="loadData()">ğŸ“‚ èª­è¾¼</button>
                <button class="btn btn-reset" onclick="resetData()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
        
        <!-- Preview -->
        <div class="preview-label">â–¼ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå®Ÿéš›ã®æ™‚é–“ã«é€£å‹•ï¼‰</div>
        <div class="board" id="board"></div>
    </div>
    
    <script>
        const dayNames = ['æœˆæ›œ', 'ç«æ›œ', 'æ°´æ›œ', 'æœ¨æ›œ', 'é‡‘æ›œ', 'åœŸæ›œ', 'æ—¥æ›œ'];
        const dayDisplay = ['æœˆ æ›œ', 'ç« æ›œ', 'æ°´ æ›œ', 'æœ¨ æ›œ', 'é‡‘ æ›œ', 'åœŸ æ›œ', 'æ—¥ æ›œ'];
        
        let config = {
            displayName: 'æ™® é€š',
            classNum: '3',
            classUnit: 'çµ„',
            scheduleType: 'æ—¥èª²',
            footerMsg: 'ç§»å‹•ã€æº–å‚™æ™‚é–“ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚æˆæ¥­ã«ã‚ˆã‚Šå¤šå°‘æ™‚é–“ãŒç•°ãªã‚Šã¾ã™ã€‚',
            endTitle: 'æœ¬æ—¥çµ‚äº†',
            endMessage: 'æœ¬æ—¥ã®æˆæ¥­ã¯å…¨ã¦çµ‚äº†ã—ã¾ã—ãŸã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚',
            schedule: []
        };
        
        // Initialize default schedule for each day
        function initDefaultSchedule() {
            const defaultPeriods = [
                { label: 'æœHR', start: '08:30', end: '08:40', isHR: true },
                { label: '1', start: '08:50', end: '09:40' },
                { label: '2', start: '09:50', end: '10:40' },
                { label: '3', start: '10:50', end: '11:40' },
                { label: '4', start: '11:50', end: '12:40' },
                { label: '5', start: '13:30', end: '14:20' },
                { label: '6', start: '14:30', end: '15:20' },
                { label: 'HR', start: '15:25', end: '15:35', isHR: true }
            ];
            
            const defaultSubjects = [
                ['æœHR', 'å›½èª', 'æ•°å­¦I', 'è‹±èªC1', 'ä½“è‚²', 'åŒ–å­¦åŸºç¤', 'åœ°ç†ç·åˆ', 'HR'],
                ['æœHR', 'åŒ–å­¦åŸºç¤', 'ä½“è‚²', 'è‹±èªC1', 'ç¾ä»£å›½èª', 'æ•°å­¦I', 'åœ°ç†ç·åˆ', 'HR'],
                ['æœHR', 'æ•°å­¦I', 'ç¾ä»£å›½èª', 'ä½“è‚²', 'è‹±èªC1', 'æƒ…å ±I', 'åŒ–å­¦åŸºç¤', 'HR'],
                ['æœHR', 'è‹±èªC1', 'åœ°ç†ç·åˆ', 'æ•°å­¦I', 'å›½èª', 'ä½“è‚²', 'éŸ³æ¥½', 'HR'],
                ['æœHR', 'åŒ–å­¦åŸºç¤', 'è‹±èªC1', 'ç¾ä»£å›½èª', 'æ•°å­¦I', 'ç·åˆ', 'LHR', 'HR'],
                ['æœHR', 'æ•°å­¦I', 'è‹±èªC1', 'å›½èª', '', '', '', 'HR'],
                ['', '', '', '', '', '', '', '']
            ];
            
            const defaultRooms = [
                ['', '', '', '', '1Fä½“è‚²é¤¨', '3Fç†ç§‘å®¤', '', ''],
                ['', '3Fç†ç§‘å®¤', '1Fä½“è‚²é¤¨', '', '', '', '', ''],
                ['', '', '', '1Fä½“è‚²é¤¨', '', '2FPCå®¤', '3Fç†ç§‘å®¤', ''],
                ['', '', '', '', '', '1Fä½“è‚²é¤¨', '4FéŸ³æ¥½å®¤', ''],
                ['', '3Fç†ç§‘å®¤', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', '']
            ];
            
            config.schedule = [];
            for (let d = 0; d < 7; d++) {
                const daySchedule = [];
                for (let p = 0; p < defaultPeriods.length; p++) {
                    daySchedule.push({
                        ...defaultPeriods[p],
                        subject: defaultSubjects[d][p] || '',
                        room: defaultRooms[d][p] || ''
                    });
                }
                config.schedule.push(daySchedule);
            }
        }
        
        let currentEditDay = 0;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initDefaultSchedule();
            loadFromStorage();
            renderDayTabs();
            renderPeriodList();
            updateBoard();
            startRealtime();
        });
        
        function startRealtime() {
            setInterval(updateBoard, 1000);
        }
        
        function getCurrentTimeInfo() {
            const now = new Date();
            const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
            const dayOfWeek = now.getDay();
            const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const daySchedule = config.schedule[adjustedDay];
            
            let currentPeriod = -1;
            let periodProgress = 0;
            let isEnded = false;
            
            if (daySchedule && daySchedule.length > 0) {
                // Check if before first period
                const firstStart = timeToMinutes(daySchedule[0].start);
                if (currentMinutes < firstStart) {
                    currentPeriod = -1;
                } else {
                    // Check each period
                    for (let i = 0; i < daySchedule.length; i++) {
                        const startMin = timeToMinutes(daySchedule[i].start);
                        const endMin = timeToMinutes(daySchedule[i].end);
                        
                        if (currentMinutes >= startMin && currentMinutes < endMin) {
                            currentPeriod = i;
                            periodProgress = (currentMinutes - startMin) / (endMin - startMin);
                            break;
                        } else if (currentMinutes >= endMin) {
                            currentPeriod = i;
                        }
                    }
                    
                    // Check if after last period
                    const lastEnd = timeToMinutes(daySchedule[daySchedule.length - 1].end);
                    if (currentMinutes >= lastEnd) {
                        isEnded = true;
                    }
                }
            }
            
            return { time: timeStr, day: adjustedDay, period: currentPeriod, progress: periodProgress, isEnded };
        }
        
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }
        
        function enterFullscreen() {
            const board = document.getElementById('board');
            if (board.requestFullscreen) {
                board.requestFullscreen();
            } else if (board.webkitRequestFullscreen) {
                board.webkitRequestFullscreen();
            } else if (board.msRequestFullscreen) {
                board.msRequestFullscreen();
            }
        }
        
        function renderDayTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = dayNames.map((name, i) =>
                `<button class="day-tab ${i === currentEditDay ? 'active' : ''}" onclick="switchEditDay(${i})">${name}</button>`
            ).join('');
        }
        
        function switchEditDay(day) {
            currentEditDay = day;
            renderDayTabs();
            renderPeriodList();
        }
        
        function renderPeriodList() {
            const container = document.getElementById('periodList');
            const daySchedule = config.schedule[currentEditDay];
            
            container.innerHTML = daySchedule.map((period, i) => `
                <div class="period-item">
                    <input type="text" class="label-input" value="${period.label}" 
                           onchange="updatePeriod(${i}, 'label', this.value)" placeholder="æ™‚é™å">
                    <input type="time" class="time-input" value="${period.start}" 
                           onchange="updatePeriod(${i}, 'start', this.value)">
                    <input type="time" class="time-input" value="${period.end}" 
                           onchange="updatePeriod(${i}, 'end', this.value)">
                    <input type="text" value="${period.subject}" 
                           onchange="updatePeriod(${i}, 'subject', this.value)" placeholder="ç§‘ç›®">
                    <input type="text" value="${period.room}" 
                           onchange="updatePeriod(${i}, 'room', this.value)" placeholder="æ•™å®¤">
                    <button class="delete-btn" onclick="deletePeriod(${i})">Ã—</button>
                </div>
            `).join('');
        }
        
        function updatePeriod(index, field, value) {
            config.schedule[currentEditDay][index][field] = value;
            if (field === 'label') {
                config.schedule[currentEditDay][index].isHR = 
                    value.includes('HR') || value.includes('ãƒ›ãƒ¼ãƒ ');
            }
            updateBoard();
        }
        
        function addPeriod() {
            const daySchedule = config.schedule[currentEditDay];
            const lastPeriod = daySchedule[daySchedule.length - 1];
            
            // Calculate new times
            let newStart = '09:00';
            let newEnd = '09:50';
            if (lastPeriod) {
                const lastEndMin = timeToMinutes(lastPeriod.end);
                const newStartMin = lastEndMin + 10;
                const newEndMin = newStartMin + 50;
                newStart = `${String(Math.floor(newStartMin / 60)).padStart(2, '0')}:${String(newStartMin % 60).padStart(2, '0')}`;
                newEnd = `${String(Math.floor(newEndMin / 60)).padStart(2, '0')}:${String(newEndMin % 60).padStart(2, '0')}`;
            }
            
            // Find next period number
            const numbers = daySchedule.map(p => parseInt(p.label)).filter(n => !isNaN(n));
            const nextNum = numbers.length > 0 ? Math.max(...numbers) + 1 : 1;
            
            daySchedule.push({
                label: String(nextNum),
                start: newStart,
                end: newEnd,
                subject: '',
                room: '',
                isHR: false
            });
            
            renderPeriodList();
            updateBoard();
        }
        
        function deletePeriod(index) {
            if (config.schedule[currentEditDay].length > 1) {
                config.schedule[currentEditDay].splice(index, 1);
                renderPeriodList();
                updateBoard();
            }
        }
        
        function updateBoard() {
            config.displayName = document.getElementById('displayName').value;
            config.classNum = document.getElementById('classNum').value;
            config.classUnit = document.getElementById('classUnit').value;
            config.scheduleType = document.getElementById('scheduleType').value;
            config.footerMsg = document.getElementById('footerMsg').value;
            config.endTitle = document.getElementById('endTitle').value;
            config.endMessage = document.getElementById('endMessage').value;
            
            const timeInfo = getCurrentTimeInfo();
            const day = timeInfo.day;
            const daySchedule = config.schedule[day];
            const period = timeInfo.period;
            
            let currentSubject = '';
            let periodDisplay = '';
            
            if (timeInfo.isEnded) {
                // Show end of day
                document.getElementById('board').innerHTML = `
                    <div class="board-header">
                        <div class="train-type-badge">${config.displayName}</div>
                        <div class="next-label"></div>
                        <div class="header-right">
                            <div class="time-section">
                                <span class="time-label">ç¾åœ¨æ™‚åˆ»</span>
                                <span class="time-value">${timeInfo.time}</span>
                            </div>
                            <div class="class-badge">
                                <div class="class-number-box">
                                    <span class="class-number-value">${config.classNum}</span>
                                </div>
                                <span class="class-unit">${config.classUnit}</span>
                            </div>
                        </div>
                    </div>
                    <div class="main-display" style="flex:1;">
                        <div class="day-section">
                            <div class="day-display">${dayDisplay[day]}</div>
                            <div class="schedule-type-display">${config.scheduleType}</div>
                        </div>
                        <div class="end-of-day-display show">
                            <div class="end-title">${config.endTitle}</div>
                            <div class="end-message">${config.endMessage.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                    <div class="board-footer">
                        <p class="footer-message">${config.footerMsg}</p>
                    </div>
                `;
                return;
            }
            
            if (period < 0 || !daySchedule || daySchedule.length === 0) {
                currentSubject = 'æˆæ¥­å‰';
                periodDisplay = 'âˆ’';
            } else if (period < daySchedule.length) {
                currentSubject = daySchedule[period].subject || 'âˆ’';
                periodDisplay = daySchedule[period].label || '';
            }
            
            // Generate schedule items
            let scheduleItems = '';
            let timelineItems = '';
            let roomItems = '';
            
            let progressWidth = 0;
            
            if (daySchedule && daySchedule.length > 0) {
                for (let i = 0; i < daySchedule.length; i++) {
                    const p = daySchedule[i];
                    const isHR = p.isHR || p.label.includes('HR');
                    const isActive = period === i && !timeInfo.isEnded;
                    const isPassed = period > i || timeInfo.isEnded;
                    const statusClass = isActive ? 'active' : (isPassed ? 'passed' : '');
                    
                    scheduleItems += `<div class="schedule-item ${isHR ? 'hr-slot' : ''}">${formatSubject(p.subject)}</div>`;
                    
                    if (isHR) {
                        timelineItems += `<div class="timeline-marker hr-slot"><div class="timeline-dot ${isPassed || isActive ? 'filled' : ''}"></div></div>`;
                    } else {
                        timelineItems += `<div class="timeline-marker"><div class="period-circle ${statusClass}">${p.label}</div></div>`;
                    }
                    
                    roomItems += `<span class="${isHR ? 'hr-slot' : ''}">${p.room}</span>`;
                    
                    if (isPassed) {
                        progressWidth = ((i + 1) / daySchedule.length) * 100;
                    } else if (isActive) {
                        progressWidth = ((i + timeInfo.progress) / daySchedule.length) * 100;
                    }
                }
            }
            
            document.getElementById('board').innerHTML = `
                <div class="board-header">
                    <div class="train-type-badge">${config.displayName}</div>
                    <div class="next-label">æ¬¡ã¯</div>
                    <div class="header-right">
                        <div class="time-section">
                            <span class="time-label">ç¾åœ¨æ™‚åˆ»</span>
                            <span class="time-value">${timeInfo.time}</span>
                        </div>
                        <div class="class-badge">
                            <div class="class-number-box">
                                <span class="class-number-value">${config.classNum}</span>
                            </div>
                            <span class="class-unit">${config.classUnit}</span>
                        </div>
                    </div>
                </div>
                
                <div class="main-display">
                    <div class="day-section">
                        <div class="day-display">${dayDisplay[day]}</div>
                        <div class="schedule-type-display">${config.scheduleType}</div>
                    </div>
                    <div class="current-period-section">
                        <div class="period-indicator">
                            <span class="period-indicator-text">${periodDisplay}</span>
                        </div>
                        <div class="current-subject">${currentSubject}</div>
                    </div>
                </div>
                
                <div class="schedule-grid-section">
                    <div class="schedule-grid">
                        ${scheduleItems}
                    </div>
                </div>
                
                <div class="timeline-section">
                    <div class="timeline">
                        <div class="timeline-track">
                            <div class="progress-fill" style="width: ${progressWidth}%"></div>
                        </div>
                        ${timelineItems}
                    </div>
                </div>
                
                <div class="room-info-section">
                    <div class="room-grid">
                        ${roomItems}
                    </div>
                </div>
                
                <div class="board-footer">
                    <p class="footer-message">${config.footerMsg}</p>
                </div>
            `;
        }
        
        function formatSubject(subject) {
            if (!subject) return '';
            
            if (subject === 'æœHR') {
                return '<span class="subject-char">æœ</span><span class="subject-char">H</span><span class="subject-char">R</span>';
            }
            if (subject === 'HR' || subject === 'çµ‚HR') {
                return '<span class="subject-char">H</span><span class="subject-char" style="margin-top:20px">R</span>';
            }
            if (subject === 'LHR') {
                return '<span class="subject-char">L</span><span class="subject-char">H</span><span class="subject-char">R</span>';
            }
            
            let result = '';
            if (subject.length <= 2) {
                for (let char of subject) {
                    result += `<span class="subject-char">${char}</span>`;
                }
            } else if (subject.length <= 4) {
                for (let i = 0; i < subject.length; i += 2) {
                    result += `<span class="subject-char">${subject.slice(i, i + 2)}</span>`;
                }
            } else {
                result += `<span class="subject-char">${subject.slice(0, 2)}</span>`;
                result += `<span class="subject-char">${subject.slice(2, 4)}</span>`;
                if (subject.length > 4) {
                    result += `<span class="subject-char" style="font-size:18px">${subject.slice(4)}</span>`;
                }
            }
            return result;
        }
        
        // Save/Load
        function saveData() {
            const dataStr = JSON.stringify(config, null, 2);
            localStorage.setItem('scheduleConfigV2', dataStr);
            
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'schedule_config.json';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼');
        }
        
        function loadData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        config = JSON.parse(e.target.result);
                        applyConfig();
                        alert('âœ… èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
                    } catch (err) {
                        alert('âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function loadFromStorage() {
            const saved = localStorage.getItem('scheduleConfigV2');
            if (saved) {
                try {
                    config = JSON.parse(saved);
                    applyConfig();
                } catch (err) {}
            }
        }
        
        function applyConfig() {
            document.getElementById('displayName').value = config.displayName || 'æ™® é€š';
            document.getElementById('classNum').value = config.classNum || '3';
            document.getElementById('classUnit').value = config.classUnit || 'çµ„';
            document.getElementById('scheduleType').value = config.scheduleType || 'æ—¥èª²';
            document.getElementById('footerMsg').value = config.footerMsg || '';
            document.getElementById('endTitle').value = config.endTitle || 'æœ¬æ—¥çµ‚äº†';
            document.getElementById('endMessage').value = config.endMessage || '';
            renderPeriodList();
            updateBoard();
        }
        
        function resetData() {
            if (confirm('âš ï¸ å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('scheduleConfigV2');
                location.reload();
            }
        }
    </script>
</body>
</html>
