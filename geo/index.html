<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ â€“ Pro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#3f51b5;/* indigo */
      --primary-600:#3949ab;
      --secondary:#ff4081;/* pink */
      --bg:#f6f7fb;
      --card-bg:#ffffff;
      --ink:#24292f;
      --muted:#6b7280;
      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --ring: 0 0 0 3px rgba(63,81,181,.18);
    }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 80% -200px, rgba(63,81,181,.12), transparent 60%) , var(--bg);
      font-family: Inter, "Noto Sans JP", "Montserrat", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--ink);
      letter-spacing:.02em;
    }
    header{
      position: sticky; top:0; z-index:10;
      background: linear-gradient(135deg, var(--primary), #5c6bc0);
      color:#fff; box-shadow: var(--shadow);
    }
    .bar{ max-width: 1100px; margin:0 auto; padding:14px 20px; display:flex; align-items:center; gap:14px; }
    .brand{ font-weight:800; font-size: clamp(18px, 3.5vw, 22px); letter-spacing:.04em; display:flex; align-items:center; gap:10px; }
    .brand img{ height:26px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,.2); }

    /* progress */
    .progress{ margin-left:auto; display:flex; align-items:center; gap:12px; }
    .pill{ background:rgba(255,255,255,.15); padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; }
    .meter{ position:relative; width:140px; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden; }
    .meter>span{ position:absolute; inset:0 100% 0 0; background: #fff; opacity:.9; transition: inset .3s ease; }

    main{ max-width:1100px; margin:18px auto; padding:0 16px; display:grid; gap:16px; grid-template-columns: 1.2fr .8fr; }
    @media (max-width: 900px){ main{ grid-template-columns: 1fr; } }

    /* cards */
    .card{ background:var(--card-bg); border-radius:var(--radius); box-shadow: var(--shadow); overflow:hidden; }
    .cardHeader{ padding:12px 14px; display:flex; align-items:center; gap:10px; border-bottom:1px solid #eef0f6; }
    .cardHeader h2{ margin:0; font-size:15px; font-weight:700; color:#111827; }

    /* map */
    #map{ height: clamp(320px, 34vh, 460px); width:100%; }
    .mapTools{ position:absolute; right:14px; top:14px; display:flex; flex-direction:column; gap:8px; }
    .fab{ background:#fff; border:none; box-shadow: var(--shadow); width:44px; height:44px; border-radius:12px; display:grid; place-items:center; cursor:pointer; transition: transform .08s ease; }
    .fab:active{ transform: translateY(1px); }

    /* locations */
    .list{ padding:10px; display:flex; flex-direction:column; gap:10px; }
    .loc{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border:1px solid #eef0f6; border-radius:12px; }
    .loc h3{ margin:0 0 4px; font-size:15px; }
    .loc .muted{ color:var(--muted); font-size:12px; }
    .loc .right{ display:flex; align-items:center; gap:8px; }
    .badge{ font-size:11px; background:#eef2ff; color:#3f51b5; padding:4px 8px; border-radius:999px; font-weight:700; }
    .stampState{ font-weight:700; font-size:12px; color:#10b981; }
    .disabled{ opacity:.6; }

    /* toolbar */
    .toolbar{ display:flex; flex-wrap:wrap; gap:10px; padding:12px; border-top:1px solid #eef0f6; background:#fbfcff; }
    .btn{ border:1px solid #e6e9f4; background:#fff; color:#111827; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700; display:flex; align-items:center; gap:8px; }
    .btn.primary{ border-color: transparent; background:linear-gradient(135deg, var(--secondary), #ff5b93); color:#fff; box-shadow: var(--ring); }
    .btn:active{ transform: translateY(1px); }

    /* card / stamp overlay */
    #cardWrap{ position:relative; background: conic-gradient(from 180deg at 50% 120%, rgba(63,81,181,.06), transparent 70%) , #fafbff; }
    #cardContainer{ position:relative; width:100%; max-width:560px; margin:16px auto 16px; padding:0; }
    #card{ width:100%; display:block; border-radius:14px; box-shadow: var(--shadow); }
    #overlay{ position:absolute; inset:0; pointer-events:none; border-radius:14px; }
    #cardContainer .stamp{ position:absolute; width: var(--stamp-size, 72px); aspect-ratio:1/1; transform: translate(-50%, -50%) rotate(-8deg); opacity:.92; user-select:none; filter: drop-shadow(0 6px 10px rgba(0,0,0,.18)); transition: left .15s ease, top .15s ease; }

    /* toast */
    #toast{ position:fixed; left:50%; bottom:24px; transform:translateX(-50%); display:grid; gap:8px; z-index:9999; }
    .toast{ background:#111827; color:#fff; padding:10px 14px; border-radius:12px; box-shadow: var(--shadow); font-weight:700; opacity:.98; }

    /* small helpers */
    .sr{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand" aria-label="ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼">
        <img src="https://raw.githubusercontent.com/takuminnnotabi/ikegaminosite/refs/heads/main/geo/geo.png" alt="ãƒ­ã‚´" />
        ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ Pro
      </div>
      <div class="progress" aria-live="polite">
        <span class="pill" id="countPill">0/0</span>
        <div class="meter" aria-hidden="true"><span id="meterFill"></span></div>
      </div>
    </div>
  </header>

  <main>
    <!-- Map card -->
    <section class="card" style="position:relative">
      <div class="cardHeader"><h2>ç¾åœ¨åœ°ã¨ã‚¹ãƒãƒƒãƒˆ</h2></div>
      <div id="map"></div>
      <div class="mapTools" aria-hidden="true">
        <button class="fab" id="btnLocate" title="ç¾åœ¨åœ°ã«ç§»å‹•">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v2m0 16v2m8-10h2M2 12H4m14.95-6.95-1.41 1.41M6.46 17.54l-1.41 1.41M17.54 17.54l1.41 1.41M6.46 6.46 5.05 5.05" stroke="#111827" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <button class="fab" id="btnFit" title="å…¨ä½“è¡¨ç¤º">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 9V4h5M15 4h5v5M20 15v5h-5M9 20H4v-5" stroke="#111827" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="list" id="locList"></div>
      <div class="toolbar">
        <button class="btn" id="btnReset">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4v6h6M20 20v-6h-6M20 9A8 8 0 1 0 7.76 4.24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          ãƒªã‚»ãƒƒãƒˆ
        </button>
        <button class="btn" id="btnDemo">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          ãƒ‡ãƒ¢æŠ¼å°
        </button>
        <button class="btn" id="btnToggleCard">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7Z" stroke="currentColor" stroke-width="2"/><path d="M8 9h8" stroke="currentColor" stroke-width="2"/></svg>
          ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º/éè¡¨ç¤º
        </button>
      </div>
    </section>

    <!-- Stamp card -->
    <section class="card" id="cardWrap">
      <div class="cardHeader"><h2>ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰</h2></div>
      <div id="cardContainer">
        <img id="card" src="https://yohakuni.com/wp-content/uploads/2023/05/stampcard4-1.png" alt="ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰" />
        <div id="overlay" aria-hidden="true"></div>
      </div>
      <div class="toolbar" style="justify-content:space-between">
        <span class="muted" style="font-size:12px">â€» é…ç½®ã¯ã‚«ãƒ¼ãƒ‰ç”»åƒã®ä¸¸ã®ä¸­å¤®ã«åˆã‚ã›ãŸå›ºå®šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ2Ã—5ï¼‰ã§ã™</span>
        <div style="display:flex; gap:10px">
          <button class="btn" id="btnDefaultSlots">åˆæœŸé…ç½®ã«æˆ»ã™</button>
        </div>
      </div>
    </section>
  </main>

  <!-- å®Œèµ°ã‚»ãƒ¬ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ & è³çŠ¶ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ—¥æœ¬èªãƒ»èªå®šç•ªå·/ç™ºè¡Œè€…/QRãªã—ï¼‰ -->
  <div id="winModal" style="position:fixed;inset:0;display:none;place-items:center;background:rgba(17,24,39,.55);z-index:9998;">
    <div style="width:min(900px,92vw);background:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.25);overflow:hidden">
      <div style="padding:14px 16px;border-bottom:1px solid #eef0f6;display:flex;align-items:center;gap:10px">
        <strong>å…¨ã‚¹ãƒãƒƒãƒˆé”æˆï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ ğŸ‰</strong>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn" id="btnCloseWin">é–‰ã˜ã‚‹</button>
        </div>
      </div>
      <div id="certWrap" style="padding:16px;background:#f6f7fb">
        <style>
          #certificate.jp { width:min(800px, 96%); margin: 10px auto; background-image:url('https://png.pngtree.com/png-vector/20221206/ourmid/pngtree-golden-blue-certificate-border-folio-f4-size-transparent-png-image_6514169.png'); background-size:cover; padding: 24px 24px 18px; box-shadow: 0 0 10px rgba(0,0,0,.08); position: relative; border-radius: 6px; font-family: 'Montserrat', 'Noto Sans JP', sans-serif; }
          #certificate.jp h1 { text-align:center; color:#b80257; margin:.4em 0; }
          #certificate.jp .field { margin: 10px 0 14px; }
          #certificate.jp .field label { font-weight:700; color:#233142; font-size:14px; }
          #certificate.jp .field input { width:100%; padding:10px 12px; border:1px solid #455d7a33; border-radius:8px; margin-top:6px; font-size:14px; }
          #certificate.jp .btn { display:block; width:100%; padding:12px; background:#f95959; color:#fff; text-align:center; border:none; border-radius:10px; cursor:pointer; font-weight:800; }
          #certificate.jp .btn:hover{ background:#b80257; }
          #certificate.jp #seal { position:absolute; top:16px; right:16px; color:#b80257; font-size:32px; }
          #certificate.jp small { color:#6b7280; display:block; margin-top:8px; text-align:center; }
        </style>
        <div id="certificate" class="jp">
          <h1>è³çŠ¶ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
          <div class="field">
            <label for="participantJP">ãŠåå‰ï¼ˆä»»æ„ï¼‰:</label>
            <input type="text" id="participantJP" placeholder="ä¾‹ï¼‰éºè·¡å¤ªéƒ æ§˜">
          </div>
          <button class="btn" id="btnGenerateJP">è³çŠ¶ã‚’ä¿å­˜</button>
          <small>â€» ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨åˆ¥ã‚¿ãƒ–ã§è³çŠ¶ãŒé–‹ãã€ç”»åƒä¿å­˜ãƒœã‚¿ãƒ³ãŒä½¿ãˆã¾ã™ã€‚</small>
          <div id="seal"><i class="fas fa-award"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" aria-live="polite"></div>

  <script>
  ;(() => {
    const STAMP_IMG = 'https://www.sozailab.jp/db_img/sozai/16330/1ac9f5dcab3a87cb7ba0a2363681ecaf.png';
    const RADIUS_M = 50; // åˆ¤å®šåŠå¾„ï¼ˆmï¼‰

    // å…µåº«çœŒè±Šå²¡å¸‚å†…ã®è€ƒå¤ç³»ã‚¹ãƒãƒƒãƒˆï¼ˆ10ç®‡æ‰€ãƒ»æ¯”è¼ƒçš„è¿‘è·é›¢ï¼‰
    const locs = [
      { id:'loc1', name:'è±Šå²¡å¸‚ç«‹æ­´å²åšç‰©é¤¨ï¼ˆä½†é¦¬å›½åºœãƒ»å›½åˆ†å¯ºé¤¨ï¼‰', lat:35.469695, lng:134.767431, stamped:false },
      { id:'loc2', name:'ç¥¢å¸ƒãƒ¶æ£®éºè·¡å…¬åœ’ï¼ˆä½†é¦¬å›½åºœæ¨å®šåœ°ï¼‰',       lat:35.470277, lng:134.769166, stamped:false },
      { id:'loc3', name:'ä½†é¦¬å›½åˆ†å¯ºè·¡ï¼ˆå¡”ç¤çŸ³ãªã©ï¼‰',                 lat:35.471848, lng:134.773208, stamped:false },
      { id:'loc4', name:'ä½†é¦¬å›½åˆ†å°¼å¯ºè·¡ï¼ˆä¼ï¼‰',                       lat:35.4802722, lng:134.7760472, stamped:false },
      { id:'loc5', name:'æ¥¯ç¸«å¤å¢³',                                   lat:35.4652694, lng:134.7968611, stamped:false },
      { id:'loc6', name:'äºŒè¦‹è°·å¤å¢³ç¾¤ï¼ˆ1å·å¢³ä»˜è¿‘ï¼‰',                 lat:35.58731441, lng:134.79862478, stamped:false },
      { id:'loc7', name:'æ£®å°¾å¤å¢³è·¡',                                 lat:35.520407, lng:134.868314, stamped:false },
      { id:'loc8', name:'ã„ãšã—å¤ä»£å­¦ç¿’é¤¨',                           lat:35.490563, lng:134.870377, stamped:false },
      { id:'loc9', name:'èŒ¶è‡¼å±±å¤å¢³',                                 lat:35.461944, lng:134.884028, stamped:false },
      { id:'loc10', name:'é¶å¡šå¤å¢³',                                   lat:35.459833, lng:134.887222, stamped:false },
    ];

    // çŠ¶æ…‹
    let map, currentMarker, watchId = null, bounds;

    // DOM
    const countPill  = document.getElementById('countPill');
    const meterFill  = document.getElementById('meterFill');
    const locList    = document.getElementById('locList');
    const btnReset   = document.getElementById('btnReset');
    const btnDemo    = document.getElementById('btnDemo');
    const btnToggleC = document.getElementById('btnToggleCard');
    const btnDefault = document.getElementById('btnDefaultSlots');
    const toastWrap  = document.getElementById('toast');
    const card       = document.getElementById('card');
    const cardContainer = document.getElementById('cardContainer');
    const overlay    = document.getElementById('overlay');

    // ä¾¿åˆ©é–¢æ•°
    const fmtDist = (m) => m < 1000 ? `${Math.round(m)}m` : `${(m/1000).toFixed(2)}km`;

    function toast(msg){
      const el = document.createElement('div'); el.className = 'toast'; el.textContent = msg; toastWrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity = '.0'; el.style.transform = 'translateY(6px)'; setTimeout(()=> el.remove(), 250); }, 1800);
    }

    // å›ºå®šã‚¹ãƒ­ãƒƒãƒˆï¼ˆ2è¡ŒÃ—5åˆ—ï¼‰
    function getFixedSlots(n){
      const xs = [0.12, 0.30, 0.50, 0.70, 0.88];
      const ys = [0.36, 0.73];
      const out = [];
      for(let i=0;i<n;i++){
        const c = i % xs.length; const r = Math.floor(i / xs.length);
        out.push({ x: xs[c] ?? 0.5, y: ys[r] ?? 0.5 });
      }
      return out.slice(0, n);
    }

    function updateStampSize(){
      const w = cardContainer.clientWidth;
      const px = Math.max(48, Math.min(86, Math.round(w * 0.14))); // 48ã€œ86px
      cardContainer.style.setProperty('--stamp-size', px + 'px');
    }

    function saveStampState(){
      const m = {}; locs.forEach(l => m[l.id] = !!l.stamped);
      localStorage.setItem('sr_v2_stamped', JSON.stringify(m));
    }
    function loadStampState(){
      try{
        const m = JSON.parse(localStorage.getItem('sr_v2_stamped')||'{}');
        locs.forEach(l => l.stamped = !!m[l.id]);
      }catch{}
    }

    function renderStamps(){
      overlay.querySelectorAll('.stamp').forEach(el => el.remove());
      const slots = getFixedSlots(locs.length);
      locs.forEach((l,i)=>{
        if(!l.stamped) return;
        const {x,y} = slots[i] || {x:.5,y:.5};
        const img = document.createElement('img');
        img.src = STAMP_IMG; img.alt = `${l.name} ã®ã‚¹ã‚¿ãƒ³ãƒ—`; img.className = 'stamp';
        img.style.left = (x*100)+'%'; img.style.top  = (y*100)+'%';
        img.animate([
          { transform:'translate(-50%,-50%) scale(.6) rotate(-12deg)', opacity:.0 },
          { transform:'translate(-50%,-50%) scale(1.15) rotate(-8deg)', opacity:.96, offset:.75 },
          { transform:'translate(-50%,-50%) scale(1) rotate(-8deg)', opacity:.96 }
        ],{ duration:420, easing:'cubic-bezier(.2,.8,.2,1)' });
        overlay.appendChild(img);
      });
    }

    function updateProgress(){
      const total = locs.length; const got = locs.filter(l=>l.stamped).length;
      countPill.textContent = `${got}/${total}`;
      const pct = Math.round((got/Math.max(1,total))*100);
      meterFill.style.inset = `0 ${100-pct}% 0 0`;
    }

    function renderList(){
      locList.innerHTML = '';
      locs.forEach((l)=>{
        const row = document.createElement('div'); row.className = 'loc';
        const left = document.createElement('div');
        const h3 = document.createElement('h3'); h3.textContent = l.name; left.appendChild(h3);
        const sub = document.createElement('div'); sub.className = 'muted';
        const dTxt = l.distance != null ? `è·é›¢: ${fmtDist(l.distance)}` : 'è·é›¢: å–å¾—ä¸­â€¦';
        sub.textContent = (l.stamped? 'âœ… æŠ¼å°æ¸ˆã¿' : 'ã‚¹ã‚¿ãƒ³ãƒ—æœªå–å¾—') + ' ãƒ» ' + dTxt;
        left.appendChild(sub);
        const right = document.createElement('div'); right.className = 'right';
        const badge = document.createElement('span'); badge.className = 'badge'; badge.textContent = RADIUS_M + 'm åœå†…ã§æŠ¼å°';
        right.appendChild(badge);
        if(l.stamped){ const ss = document.createElement('span'); ss.className='stampState'; ss.textContent='Complete'; right.appendChild(ss); row.classList.add('disabled'); }
        row.append(left, right);
        locList.appendChild(row);
      });
    }

    function distanceMeters(lat1, lon1, lat2, lon2){
      const R = 6371000; const toRad = deg => deg * Math.PI/180;
      const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function tryStampByPosition(lat, lng){
      let updated = false;
      locs.forEach((l)=>{
        const d = distanceMeters(lat, lng, l.lat, l.lng);
        l.distance = d;
        if(!l.stamped && d <= RADIUS_M){ l.stamped = true; updated = true; toast(`ã€Œ${l.name}ã€ã«åˆ°ç€ï¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã—ã¾ã—ãŸã€‚`); }
      });
      if(updated){
        saveStampState(); renderStamps(); updateProgress(); renderList();
        if(locs.every(x=>x.stamped)) celebrateAndShowCertificate();
      }
    }

    function onPosition(pos){
      const { latitude, longitude } = pos.coords;
      const p = { lat: latitude, lng: longitude };
      if(!currentMarker){
        currentMarker = new google.maps.Marker({ position: p, map, icon:{ path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor:'#3f51b5', fillOpacity:.7, strokeWeight:2 } });
      }else{ currentMarker.setPosition(p); }
      tryStampByPosition(latitude, longitude);
    }

    function onGeoError(err){ toast('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼: '+ err.message); if(watchId) navigator.geolocation.clearWatch(watchId); }

    function fitAll(){
      bounds = new google.maps.LatLngBounds();
      locs.forEach(l => bounds.extend({lat:l.lat, lng:l.lng}));
      if(currentMarker) bounds.extend(currentMarker.getPosition());
      map.fitBounds(bounds);
    }

    // Google Map åˆæœŸåŒ–
    window.initMap = function(){
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12, center: {lat:35.5, lng:134.83},
        disableDefaultUI: true,
        styles: [
          { elementType:'geometry', stylers:[{color:'#f5f5f5'}]},
          { elementType:'labels.icon', stylers:[{visibility:'off'}]},
          { elementType:'labels.text.fill', stylers:[{color:'#616161'}]},
          { elementType:'labels.text.stroke', stylers:[{color:'#f5f5f5'}]},
          { featureType:'administrative.land_parcel', elementType:'labels', stylers:[{visibility:'off'}]},
          { featureType:'poi', elementType:'labels.text', stylers:[{visibility:'off'}]},
          { featureType:'poi.park', elementType:'geometry', stylers:[{color:'#e5f2e8'}]},
          { featureType:'road', elementType:'geometry', stylers:[{color:'#ffffff'}]},
          { featureType:'road', elementType:'labels.icon', stylers:[{visibility:'off'}]},
          { featureType:'water', elementType:'geometry', stylers:[{color:'#d2e7fb'}]}
        ]
      });

      // ã‚¹ãƒãƒƒãƒˆ
      locs.forEach(l => { l.marker = new google.maps.Marker({ position:{lat:l.lat, lng:l.lng}, map, title:l.name }); });
      fitAll();

      // ä½ç½®ç›£è¦–
      if(location.protocol !== 'https:' && location.hostname !== 'localhost'){
        toast('HTTPSã§é–‹ãã¨è‡ªå‹•æŠ¼å°ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™');
      }
      if(navigator.geolocation){
        watchId = navigator.geolocation.watchPosition(onPosition, onGeoError, { enableHighAccuracy:true, maximumAge:0, timeout: 15000 });
      }

      renderList();
      if(locs.every(x=>x.stamped)) celebrateAndShowCertificate();
    };

    // UI ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('btnLocate').addEventListener('click', ()=>{
      if(currentMarker){ map.panTo(currentMarker.getPosition()); map.setZoom(15); } else toast('ç¾åœ¨åœ°ãŒã¾ã å–å¾—ã§ãã¦ã„ã¾ã›ã‚“');
    });
    document.getElementById('btnFit').addEventListener('click', fitAll);

    btnReset.addEventListener('click', ()=>{
      locs.forEach(l => l.stamped=false); saveStampState(); renderStamps(); updateProgress(); renderList(); toast('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    });
    btnDemo.addEventListener('click', ()=>{
      const next = locs.find(l => !l.stamped);
      if(!next){ toast('ã™ã¹ã¦æŠ¼å°æ¸ˆã¿ã§ã™ï¼'); celebrateAndShowCertificate(); return; }
      next.stamped = true; saveStampState(); renderStamps(); updateProgress(); renderList(); toast(`ãƒ‡ãƒ¢: ã€Œ${next.name}ã€ã‚’æŠ¼å°ã—ã¾ã—ãŸ`);
      if(locs.every(x=>x.stamped)) celebrateAndShowCertificate();
    });
    btnToggleC.addEventListener('click', ()=>{
      const wrap = document.getElementById('cardWrap');
      wrap.style.display = (getComputedStyle(wrap).display === 'none') ? 'block' : 'none';
    });
    btnDefault.addEventListener('click', ()=>{
      renderStamps(); toast('åˆæœŸé…ç½®ã«æˆ»ã—ã¾ã—ãŸ');
    });

    // åˆæœŸåŒ–
    loadStampState();
    renderStamps();
    updateProgress();

    card.addEventListener('load', ()=>{ updateStampSize(); renderStamps(); });
    window.addEventListener('resize', updateStampSize);

  })();
  </script>

  <script>
  function celebrateAndShowCertificate(){
    if(window.confetti){
      const shoot = () => {
        confetti({ particleCount: 160, spread: 75, origin: { y: 0.6 } });
        confetti({ particleCount: 120, angle: 60, spread: 65, origin: { x: 0 }, scalar: 0.9 });
        confetti({ particleCount: 120, angle: 120, spread: 65, origin: { x: 1 }, scalar: 0.9 });
      };
      shoot(); setTimeout(shoot, 450); setTimeout(shoot, 1000);
    }
    document.getElementById('winModal').style.display = 'grid';
  }
  </script>

  <script>
  // æ—¥æœ¬èªç‰ˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆèªå®šç•ªå·/ç™ºè¡Œè€…/QRãªã— + ä¿å­˜ãƒœã‚¿ãƒ³ä»˜ãåˆ¥ã‚¿ãƒ–ï¼‰
  function generateCertificateJP(){
    const participantInput = document.getElementById('participantJP').value.trim();
    const participant = participantInput || 'å‚åŠ è€…æ§˜';
    const today = new Date().toLocaleDateString('ja-JP');

    const certificateContent = `
      <h1>è³çŠ¶</h1>
      <p style="text-align:center;color:#233142;">æœ¬çŠ¶ã¯ã€</p>
      <h2 style=\"text-align:center;color:#b80257;\">${participant}</h2>
      <p style="text-align:center;color:#233142;">ãŒ <strong style=\"color:#f95959;\">å…µåº«çœŒè±Šå²¡å¸‚ è€ƒå¤å­¦ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</strong> ã‚’å®Œèµ°ã—ã€</p>
      <h3 style="text-align:center;color:#b80257;">è€ƒå¤å­¦ãƒã‚¹ã‚¿ãƒ¼ã«ãªã‚Šã¾ã—ãŸ</h3>
      <p style="text-align:center;color:#233142;">ã“ã¨ã‚’ã“ã“ã«ç§°ã—ã¾ã™ã€‚</p>
      <p style="text-align:center;color:#233142;">ç™ºè¡Œæ—¥ï¼š${today}</p>
    `;

    const w = window.open('', '_blank');
    if(!w){ alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚'); return; }
    w.document.open();
    w.document.write(`
      <html>
      <head>
        <meta charset=\"UTF-8\">
        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
        <title>è³çŠ¶</title>
        <link href=\"https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap\" rel=\"stylesheet\">
        <style>
          body { font-family: 'Montserrat', sans-serif; background:#f5f6fb; margin:0; }
          #tools { position:sticky; top:0; display:flex; gap:10px; justify-content:center; background:#fff; padding:10px; box-shadow:0 2px 10px rgba(0,0,0,.08); z-index:10; }
          #tools button { border:1px solid #e6e9f4; background:#fff; padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer; }
          #tools button.primary { background:#f95959; color:#fff; border-color:transparent; }
          #certificate { width: 800px; margin: 20px auto; background-image: url('https://png.pngtree.com/png-vector/20221206/ourmid/pngtree-golden-blue-certificate-border-folio-f4-size-transparent-png-image_6514169.png'); background-size: cover; padding: 100px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); position: relative; }
          #certificate h1, #certificate h2, #certificate h3 { text-align: center; color: #b80257; margin:.4em 0; }
          #certificate p { text-align: center; color: #233142; margin:.35em 0; }
          #certificate strong { color: #f95959; }
          #seal { position: absolute; top: 20px; right: 20px; color: #b80257; font-size: 36px; }
        </style>
      </head>
      <body>
        <div id=\"tools\">
          <button id=\"savePng\" class=\"primary\">ç”»åƒã¨ã—ã¦ä¿å­˜ï¼ˆPNGï¼‰</button>
          <button id=\"print\">å°åˆ·</button>
        </div>
        <div id=\"certificate\">
          <div id=\"seal\">â˜…</div>
          ${certificateContent}
        </div>
      </body>
      </html>
    `);
    w.document.close();

    // html2canvas ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰ãƒœã‚¿ãƒ³å‹•ä½œã‚’è¨­å®š
    const s = w.document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    s.onload = function(){
      w.document.getElementById('print').addEventListener('click', ()=> w.print());
      w.document.getElementById('savePng').addEventListener('click', async ()=>{
        const el = w.document.getElementById('certificate');
        const canvas = await w.html2canvas(el, { scale: 2 });
        const url = canvas.toDataURL('image/png');
        const a = w.document.createElement('a'); a.href = url; a.download = 'certificate.png'; a.click();
      });
    };
    w.document.body.appendChild(s);
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'btnGenerateJP') generateCertificateJP();
    if(e.target && e.target.id === 'btnCloseWin') document.getElementById('winModal').style.display = 'none';
  });
  </script>

  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆCDNï¼‰: confetti -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.9.3/confetti.min.js"></script>

  <!-- Maps APIï¼ˆæŒ‡å®šã‚­ãƒ¼ï¼‰ -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB04-heQzWfpUDS5ffARVYdtAr9_nV_dBE&callback=initMap"></script>
</body>
</html>
